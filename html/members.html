<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OXDN â€“ Members</title>
  <link rel="icon" type="image/png" href="../assets/logo.png">
  <link rel="apple-touch-icon" href="../assets/logo.png">
  <link rel="stylesheet" href="../css/homepage.css" />
  <link rel="stylesheet" href="../css/members.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <header>
    <a href="homepage.html" class="logo-link">
      <img src="../assets/logo.png" alt="OXDN Logo" class="logo" />
    </a>
    <nav>
      <a href="homepage.html">Home</a>
      <a href="login.html">Login</a>
      <a href="register.html">Register</a>
      <a href="members.html">Members</a>
      <a href="https://discord.gg/8yNvnbdm5r"><i class="fab fa-discord"></i> Discord</a>
    </nav>
  </header>

  <main>
    <h1>OXIDANE</h1>
    
    <section class="member-section admins">
      <h2>Administrators</h2>
      <div class="member-grid">
        <!-- Founders Group -->
        <div class="member-card admin">
          <div class="status-indicator online"></div>
          <img src="../assets/members/KenwayPfp.jpg" alt="Kenway" class="member-avatar">
          <div class="member-info">
            <h3>@Kenway</h3>
            <div class="role-badges">
              <span class="badge admin">Admin</span>
              <span class="badge founder">Founder</span>
            </div>
          </div>
        </div>
        <div class="member-card admin">
          <div class="status-indicator offline"></div>
          <img src="../assets/members/default-avatar.png" alt="Founder" class="member-avatar">
          <div class="member-info">
            <h3>@Founder</h3>
            <div class="role-badges">
              <span class="badge admin">Admin</span>
              <span class="badge founder">Founder</span>
            </div>
          </div>
        </div>
        <div class="member-card admin">
          <div class="status-indicator away"></div>
          <img src="../assets/members/HeureuxPfp.jpg" alt="Founder" class="member-avatar">
          <div class="member-info">
            <h3>@Heureux</h3>
            <div class="role-badges">
              <span class="badge admin">Admin</span>
              <span class="badge founder">Founder</span>
            </div>
          </div>
        </div>

        <!-- Co-Founders Group -->
        <div class="member-card admin">
          <div class="status-indicator online"></div>
          <img src="../assets/members/TessaPfp.jpg" alt="Tessanial" class="member-avatar">
          <div class="member-info">
            <h3>@Tessanial</h3>
            <div class="role-badges">
              <span class="badge admin">Admin</span>
              <span class="badge founder">Founder</span>
            </div>
          </div>
        </div>
        <div class="member-card admin">
          <div class="status-indicator online"></div>
          <img src="../assets/members/InzioPfp.jpg" alt="Co-Founder" class="member-avatar">
          <div class="member-info">
            <h3>@Inzio</h3>
            <div class="role-badges">
              <span class="badge admin">Admin</span>
              <span class="badge founder">Founder</span>
            </div>
          </div>
        </div>
        <div class="member-card admin">
          <div class="status-indicator offline"></div>
          <img src="../assets/members/HatsuePfp.jpg" alt="Co-Founder" class="member-avatar">
          <div class="member-info">
            <h3>@Hatsue</h3>
            <div class="role-badges">
              <span class="badge admin">Admin</span>
              <span class="badge founder">Founder</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="member-section moderators">
      <h2>Moderators</h2>
      <div class="member-grid">
        <div class="member-card moderator">
          <div class="status-indicator online"></div>
          <img src="../assets/members/default-avatar.png" alt="Moderator" class="member-avatar">
          <div class="member-info">
            <h3>@Moderator1</h3>
            <div class="role-badges">
              <span class="badge moderator">Moderator</span>
              <span class="badge senior">Senior</span>
            </div>
          </div>
        </div>
        <div class="member-card moderator">
          <div class="status-indicator online"></div>
          <img src="../assets/members/default-avatar.png" alt="Moderator" class="member-avatar">
          <div class="member-info">
            <h3>@Moderator2</h3>
            <div class="role-badges">
              <span class="badge moderator">Moderator</span>
              <span class="badge events">Events</span>
            </div>
          </div>
        </div>
        <div class="member-card moderator">
          <div class="status-indicator away"></div>
          <img src="../assets/members/default-avatar.png" alt="Moderator" class="member-avatar">
          <div class="member-info">
            <h3>@Moderator3</h3>
            <div class="role-badges">
              <span class="badge moderator">Moderator</span>
              <span class="badge senior">Senior</span>
            </div>
          </div>
        </div>
        <div class="member-card moderator">
          <div class="status-indicator offline"></div>
          <img src="../assets/members/default-avatar.png" alt="Moderator" class="member-avatar">
          <div class="member-info">
            <h3>@Moderator4</h3>
            <div class="role-badges">
              <span class="badge moderator">Moderator</span>
              <span class="badge events">Events</span>
            </div>
          </div>
        </div>
        <div class="member-card moderator">
          <div class="status-indicator online"></div>
          <img src="../assets/members/default-avatar.png" alt="Moderator" class="member-avatar">
          <div class="member-info">
            <h3>@Moderator5</h3>
            <div class="role-badges">
              <span class="badge moderator">Moderator</span>
              <span class="badge senior">Senior</span>
            </div>
          </div>
        </div>
        <div class="member-card moderator">
          <div class="status-indicator away"></div>
          <img src="../assets/members/default-avatar.png" alt="Moderator" class="member-avatar">
          <div class="member-info">
            <h3>@Moderator6</h3>
            <div class="role-badges">
              <span class="badge moderator">Moderator</span>
              <span class="badge events">Events</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="member-section members">
      <h2>Members</h2>
      <div class="member-grid">
        <div class="member-card member">
          <div class="status-indicator online"></div>
          <img src="../assets/members/default-avatar.png" alt="Member" class="member-avatar">
          <div class="member-info">
            <h3>@Member1</h3>
            <div class="role-badges">
              <span class="badge member">Member</span>
              <span class="badge active">Active</span>
            </div>
          </div>
        </div>
        <div class="member-card member">
          <div class="status-indicator away"></div>
          <img src="../assets/members/default-avatar.png" alt="Member" class="member-avatar">
          <div class="member-info">
            <h3>@Member2</h3>
            <div class="role-badges">
              <span class="badge member">Member</span>
              <span class="badge active">Active</span>
            </div>
          </div>
        </div>
        <div class="member-card member">
          <div class="status-indicator offline"></div>
          <img src="../assets/members/default-avatar.png" alt="Member" class="member-avatar">
          <div class="member-info">
            <h3>@Member3</h3>
            <div class="role-badges">
              <span class="badge member">Member</span>
              <span class="badge new">New</span>
            </div>
          </div>
        </div>
        <div class="member-card member">
          <div class="status-indicator online"></div>
          <img src="../assets/members/default-avatar.png" alt="Member" class="member-avatar">
          <div class="member-info">
            <h3>@Member4</h3>
            <div class="role-badges">
              <span class="badge member">Member</span>
              <span class="badge active">Active</span>
            </div>
          </div>
        </div>
        <div class="member-card member">
          <div class="status-indicator away"></div>
          <img src="../assets/members/default-avatar.png" alt="Member" class="member-avatar">
          <div class="member-info">
            <h3>@Member5</h3>
            <div class="role-badges">
              <span class="badge member">Member</span>
              <span class="badge active">Active</span>
            </div>
          </div>
        </div>
        <div class="member-card member">
          <div class="status-indicator offline"></div>
          <img src="../assets/members/default-avatar.png" alt="Member" class="member-avatar">
          <div class="member-info">
            <h3>@Member6</h3>
            <div class="role-badges">
              <span class="badge member">Member</span>
              <span class="badge new">New</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <style>
    .logo-link {
      display: flex;
      align-items: center;
      text-decoration: none;
      transition: transform 0.3s ease;
    }

    .logo-link:hover {
      transform: scale(1.05);
    }

    .logo {
      height: 40px;
      width: auto;
    }
  </style>

  <script type="module">
    import { auth } from './config/firebase.js';
    import { onAuthStateChanged } from './services/auth.js';
    import { getFirestore, collection, getDocs, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { updateUserStatus, listenToUserStatus } from './services/onlineStatus.js';
    import { updateUserData } from './services/user.js';

    // Check authentication state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in, update their status to online
        updateUserStatus(user.uid, 'online');
        
        // Update user data in Firestore
        updateUserData(user.uid, {
          displayName: user.displayName,
          email: user.email,
          photoURL: user.photoURL,
          role: 'Member', // Default role, can be updated later
        });

        // Fetch and display members
        displayMembers();
      } else {
        // User is signed out, redirect to homepage
        window.location.replace('homepage.html');
      }
    });

    // Fetch and display members
    async function displayMembers() {
      try {
        const db = getFirestore();
        const membersCollection = collection(db, 'users');
        
        // Listen for real-time updates
        onSnapshot(membersCollection, (snapshot) => {
          // Clear existing members
          document.querySelectorAll('.member-grid').forEach(grid => {
            grid.innerHTML = '';
          });

          // Add each member to the appropriate section
          snapshot.forEach((doc) => {
            const memberData = doc.data();
            const memberCard = createMemberCard(memberData);
            
            // Listen to user's online status
            listenToUserStatus(doc.id, (status) => {
              const statusIndicator = memberCard.querySelector('.status-indicator');
              statusIndicator.className = `status-indicator ${status}`;
            });

            // Add to appropriate section based on role
            const section = document.querySelector(`.member-section h2:contains('${getSectionForRole(memberData.role)}')`).closest('.member-section');
            section.querySelector('.member-grid').appendChild(memberCard);
          });
        });
      } catch (error) {
        console.error("Error fetching members:", error);
      }
    }

    function getSectionForRole(role) {
      const roleMap = {
        'Admin': 'Administrators',
        'Moderator': 'Moderators',
        'Member': 'Members'
      };
      return roleMap[role] || 'Members';
    }

    function createMemberCard(member) {
      const card = document.createElement('div');
      card.className = `member-card ${member.role.toLowerCase()}`;
      
      const statusClass = member.isOnline ? 'online' : member.isAway ? 'away' : 'offline';
      
      card.innerHTML = `
        <div class="status-indicator ${statusClass}"></div>
        <img src="${member.photoURL || 'assets/default-avatar.png'}" alt="${member.displayName}" class="member-avatar">
        <div class="member-info">
          <h3>${member.displayName}</h3>
          <div class="role-badges">
            <span class="badge ${member.role.toLowerCase()}">${member.role}</span>
            ${member.subRole ? `<span class="badge ${member.subRole.toLowerCase()}">${member.subRole}</span>` : ''}
          </div>
        </div>
      `;
      
      return card;
    }

    // Load members when page loads
    displayMembers();
  </script>
</body>
</html>
