<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OXDN - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="../assets/logo.png">
    <link rel="apple-touch-icon" href="../assets/logo.png">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../assets/logo.png" alt="OXDN Logo" class="logo">
            </div>
            
            <div class="user-profile">
                <div id="userAvatar" class="avatar">?</div>
                <div class="user-info">
                    <h3 id="userName">Admin</h3>
                    <span id="userRole" class="user-role admin-role">Administrator</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <button id="overviewBtn" class="nav-btn active">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Overview
                </button>
                <button id="usersBtn" class="nav-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    User Management
                </button>
                <button id="statsBtn" class="nav-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    Statistics
                </button>
            </nav>

            <div class="sidebar-footer">
                <button id="logoutBtn" class="logout-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <section id="overviewSection" class="dashboard-section active">
                <div class="section-header">
                    <h1>Admin Overview</h1>
                    <p class="last-update">Last updated: <span id="lastUpdate">-</span></p>
                </div>

                <div class="dashboard-grid">
                    <div class="card stats-card">
                        <div class="card-header">
                            <h3>Site Statistics</h3>
                        </div>
                        <div class="card-content">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">Total Users</span>
                                    <span id="totalUsers" class="stat-value">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Active Users</span>
                                    <span id="activeUsers" class="stat-value">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">New Users Today</span>
                                    <span id="newUsers" class="stat-value">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card activity-card">
                        <div class="card-header">
                            <h3>Recent Activity</h3>
                        </div>
                        <div class="card-content">
                            <div id="activityList" class="activity-list">
                                <!-- Activity items will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- User Management Section -->
            <section id="usersSection" class="dashboard-section">
                <div class="section-header">
                    <h1>User Management</h1>
                    <div class="header-actions">
                        <input type="text" id="userSearch" placeholder="Search users..." class="search-input">
                        <button id="addUserBtn" class="action-btn">Add User</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-content">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- User rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Statistics Section -->
            <section id="statsSection" class="dashboard-section">
                <div class="section-header">
                    <h1>Detailed Statistics</h1>
                    <div class="header-actions">
                        <select id="timeRange" class="time-select">
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>User Growth</h3>
                        </div>
                        <div class="card-content">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>User Activity</h3>
                        </div>
                        <div class="card-content">
                            <canvas id="userActivityChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <div id="error" class="error"></div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <button class="close-btn">&times;</button>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="newUserEmail">Email</label>
                    <input type="email" id="newUserEmail" required>
                </div>
                <div class="form-group">
                    <label for="newUserRole">Role</label>
                    <select id="newUserRole" required>
                        <option value="member">Member</option>
                        <option value="moderator">Moderator</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="submit-btn">Add User</button>
                    <button type="button" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { getCurrentUser, signOut } from '../services/auth.js';
        import { getUserProfile } from '../services/profile.js';
        import { updateOnlineStatus, subscribeToOnlineStatus } from '../services/status.js';
        import { getUserStats } from '../services/stats.js';

        // Check if we're in development mode
        const isDevMode = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') && 
                         window.location.port === '3000';

        // UI Elements
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const lastUpdate = document.getElementById('lastUpdate');
        const totalUsers = document.getElementById('totalUsers');
        const activeUsers = document.getElementById('activeUsers');
        const newUsers = document.getElementById('newUsers');
        const activityList = document.getElementById('activityList');
        const usersTableBody = document.getElementById('usersTableBody');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');

        // Navigation
        const overviewBtn = document.getElementById('overviewBtn');
        const usersBtn = document.getElementById('usersBtn');
        const statsBtn = document.getElementById('statsBtn');
        const overviewSection = document.getElementById('overviewSection');
        const usersSection = document.getElementById('usersSection');
        const statsSection = document.getElementById('statsSection');

        // Helper Functions
        function showLoading() {
            loading.classList.add('active');
        }

        function hideLoading() {
            loading.classList.remove('active');
        }

        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
            setTimeout(() => {
                error.classList.remove('show');
            }, 5000);
        }

        function getInitials(name) {
            if (!name) return '?';
            return name
                .split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Navigation Handlers
        overviewBtn.addEventListener('click', () => {
            setActiveSection(overviewSection);
            setActiveButton(overviewBtn);
        });

        usersBtn.addEventListener('click', () => {
            setActiveSection(usersSection);
            setActiveButton(usersBtn);
        });

        statsBtn.addEventListener('click', () => {
            setActiveSection(statsSection);
            setActiveButton(statsBtn);
        });

        function setActiveSection(section) {
            document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active'));
            section.classList.add('active');
        }

        function setActiveButton(button) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        // Update UI with admin data
        async function updateAdminData() {
            try {
                showLoading();
                
                // Get current user
                const user = await getCurrentUser();
                if (!user) {
                    throw new Error("No user is currently signed in");
                }

                // Verify admin status
                const { data: profile, error: profileError } = await getUserProfile(user.id);
                if (profileError) throw profileError;
                
                if (profile.role !== 'admin') {
                    throw new Error("Unauthorized access");
                }

                // Update UI elements
                const displayName = profile.username || user.email?.split('@')[0] || 'Admin';
                userName.textContent = displayName;
                userAvatar.textContent = getInitials(displayName);
                lastUpdate.textContent = formatDate(new Date());

                // Update online status
                await updateOnlineStatus(user.id, 'online');

                // Load initial data
                await loadSiteStats();
                await loadUserList();
                await loadActivityLog();

                hideLoading();
            } catch (error) {
                console.error('Error updating admin data:', error);
                showError(error.message);
                hideLoading();
                
                if (error.message.includes("Unauthorized access") || 
                    error.message.includes("No user is currently signed in")) {
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            }
        }

        // Load site statistics
        async function loadSiteStats() {
            try {
                // TODO: Implement actual stats loading
                totalUsers.textContent = '0';
                activeUsers.textContent = '0';
                newUsers.textContent = '0';
            } catch (error) {
                console.error('Error loading site stats:', error);
                showError('Failed to load site statistics');
            }
        }

        // Load user list
        async function loadUserList() {
            try {
                // TODO: Implement actual user list loading
                usersTableBody.innerHTML = '<tr><td colspan="5">Loading users...</td></tr>';
            } catch (error) {
                console.error('Error loading user list:', error);
                showError('Failed to load user list');
            }
        }

        // Load activity log
        async function loadActivityLog() {
            try {
                // TODO: Implement actual activity log loading
                activityList.innerHTML = '<div class="activity-item">Loading activity...</div>';
            } catch (error) {
                console.error('Error loading activity log:', error);
                showError('Failed to load activity log');
            }
        }

        // Initialize admin dashboard
        if (isDevMode) {
            // Skip authentication in development mode
            updateAdminData();
        } else {
            // Check authentication and update data
            const user = await getCurrentUser();
            if (user) {
                updateAdminData();
            } else {
                window.location.href = 'login.html';
            }
        }

        // Set up real-time subscriptions
        if (!isDevMode) {
            const user = await getCurrentUser();
            if (user) {
                // Subscribe to online status changes
                subscribeToOnlineStatus((payload) => {
                    console.log('Online status changed:', payload);
                    // Update UI as needed
                });
            }
        }

        // Logout Handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (isDevMode) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                showLoading();
                const { error } = await signOut();
                if (error) throw error;
                
                // Update online status to offline
                const user = await getCurrentUser();
                if (user) {
                    await updateOnlineStatus(user.id, 'offline');
                }
                
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                showError(error.message);
                hideLoading();
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'hidden') {
                const user = await getCurrentUser();
                if (user) {
                    await updateOnlineStatus(user.id, 'away');
                }
            } else if (document.visibilityState === 'visible') {
                const user = await getCurrentUser();
                if (user) {
                    await updateOnlineStatus(user.id, 'online');
                }
            }
        });
    </script>

    <style>
        /* Admin-specific styles */
        .admin-role {
            background-color: #dc3545;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .action-btn:hover {
            background-color: #0056b3;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .users-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .submit-btn,
        .cancel-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .submit-btn {
            background-color: #28a745;
            color: white;
        }

        .cancel-btn {
            background-color: #6c757d;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .stat-label {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #212529;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .activity-item:last-child {
            border-bottom: none;
        }
    </style>
</body>
</html> 